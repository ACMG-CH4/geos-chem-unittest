#!/bin/bash

#SBATCH -n 6
#SBATCH -N 1
#SBATCH -t 0-12:00
#SBATCH -p jacob
#SBATCH --mem-per-cpu=4500
#SBATCH --mail-type=ALL
#SBATCH --mail-user=your_email
#SBATCH -o slurm-%j.out
#SBATCH -e slurm-%j.err

#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: GCHP_slurm.run
#
# !DESCRIPTION: This bash script is a template run script for GCHP
#\\
#\\
# !REMARKS:
# Designed to be used on the Harvard Odyssey system, but may be adapted
# for other SLURM-based compute clusters.
#
# !CALLING SEQUENCE:
#  To submit run to the SLURM system:
#   sbatch GCHP.run
#
# !REVISION HISTORY:
#  Check the git history for revision history
#EOP
#------------------------------------------------------------------------------
#BOC

# Set and source your bashrc

BASHRC=GCHP.ifort15_mvapich2_odyssey.bashrc
echo "WARNING: You are using environment settings in $BASHRC"
source $BASHRC

# GCHP uses MPI instead of OpenMP for all parallelization
export OMP_NUM_THREADS=1

#-------------------------------------------------
# Initialize
#-------------------------------------------------
# Define version ID
id="GCHP"

# Define GEOS-Chem log file
log="GCHP.log"

#-------------------------------------------------
# Start the simulation
#-------------------------------------------------
# Run GCHP. Make sure the # of cpus match those above!!
time srun -n 6 --mpi=pmi2 ./geos >> $log

# Echo end fin
echo '===> Run ended at' `date` >> $log

#-------------------------------------------------
# Clean up
#-------------------------------------------------
## Echo info from computational cores to log file for displaying results
nodeName=`uname -n`
# This does not work out so well on MPI (!)
#echo "# of CPUs: $SLURM_NTASKS"
#echo "NodeName : $nodeName"
#grep "vendor_id"  /proc/cpuinfo
#grep "model name" /proc/cpuinfo
#grep "cpu MHz"    /proc/cpuinfo

# Clear variable
unset id
unset log
unset nodename

# Exit normally
exit 0
#EOC
