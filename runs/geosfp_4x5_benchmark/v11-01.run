#!/bin/bash

#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: v11-01.run
#
# !DESCRIPTION: This bash script submits a 1-month benchmark simulation
#\\
#\\
# !REMARKS:
# Designed to be used with the geosfp_4x5_benchmark run directory created
# by the GEOS-Chem Unit Tester. To use this script, you must first compile
# the GEOS-Chem code using the command "make -j4 mpbuild" to create the
# geos.mp executable.
#
# !CALLING SEQUENCE:
#  To submit run to the SGE batch queue system:
#   qsub -cwd -b y -j y -r y -pe smp8 8 v11-01.run
#
#  To run interactively:
#   v11-01.run
#
# !REVISION HISTORY:
#  17 Jun 2015 - M. Sulprizio- Initial version
#EOP
#------------------------------------------------------------------------------
#BOC

#-------------------------------------------------
# Settings for the SLURM scheduler
#-------------------------------------------------
#SBATCH -n 8                                # Number of CPUs you are requesting
#SBATCH -N 1                                # Ask for all CPUs on the same node
#SBATCH -t 720                              # Runtime in minutes (minimum: 10)
#SBATCH -p jacob                            # Partition to submit to (see above)
#SBATCH --mem-per-cpu=1000                  # Memory per cpu in MB. 
#SBATCH -o v11-01.out                       # File where stdout will be written 
#SBATCH -e v11-01.err                       # File where stderr will be written 
#SBATCH --mail-type=END                     # Type of email notification 
#SBATCH --mail-user=mpayer@seas.harvard.edu # Your email address

# Set the proper # of threads for OpenMP
# SLURM_NTASKS ensures this matches the number you set with -n above
export OMP_NUM_THREADS=$SLURM_NTASKS

#-------------------------------------------------
# Initialize
#-------------------------------------------------
# Define version ID
id="v11-01d"

# Define GEOS-Chem log file
log="$id.log"

#-------------------------------------------------
# Start the simulation
#-------------------------------------------------
# Run GEOS-Chem and pipe output to log
time ./geos.mp >> $log

# Echo end fin
echo '===> Run ended at' `date` >> $log

#-------------------------------------------------
# Clean up
#-------------------------------------------------
# Rename output file
if [ -f trac_avg.geosfp_4x5_benchmark.201307010000 ]; then
   mv -fv trac_avg.geosfp_4x5_benchmark.201307010000 trac_avg.$id
fi

# Clear variable
unset id
unset log

# Exit normally
exit 0
#EOC
