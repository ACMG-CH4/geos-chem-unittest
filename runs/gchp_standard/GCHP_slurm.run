#!/bin/bash

#SBATCH -n 6
#SBATCH -N 1
#SBATCH -t 0-1:00
#SBATCH -p regal
#SBATCH --mem-per-cpu=6000
#SBATCH --mail-type=ALL

#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: GCHP_slurm.run
#
# !DESCRIPTION: This bash script is a template run script for GCHP
#\\
#\\
# !REMARKS:
# (1) Designed to be used on the Harvard Odyssey system, but may be adapted
#     for other SLURM-based compute clusters.
# (2) The memory included by default assumes a c24 run. It will need to be
#     increased for higher resolutions.
#
# !CALLING SEQUENCE:
#  To submit run to the SLURM system:
#   sbatch GCHP.run
#
# !REVISION HISTORY:
#  Check the git history for revision history
#EOP
#------------------------------------------------------------------------------
#BOC

# Define GEOS-Chem log file
log="GCHP.log"

# Sync all config files with settings in runConfig.sh                           
./runConfig.sh > runConfig.log
if [[ $? == 0 ]]; then

    # Set and source your bashrc
    BASHRC=GCHP.ifort15_mvapich2_odyssey.bashrc
    echo "WARNING: You are using environment settings in $BASHRC"
    source $BASHRC

    # Start the simulation
    # SLURM_NTASKS is set to #SBATCH -n and SLURM_NNODES is set to #SBATCH -N above
    time srun -n $SLURM_NTASKS -N $SLURM_NNODES --mpi=pmi2 ./geos >> $log

    # Echo end fin
    echo '===> Run ended at' `date` >> $log

    # Echo info from computational cores to log file for displaying results
    echo "# of CPUs : $SLURM_NTASKS"
    echo "# of nodes: $SLURM_NNODES"

else
    cat runConfig.log
fi

# Clear variable
unset log

# Exit normally
exit 0
#EOC
