#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: Makefile
#
# !DESCRIPTION: Utility Makefile for the GCHP run directory.
#\\
#\\
# !REMARKS:
#   (1) This Makefile currently does not work for source code compiling
#       because the path suffixes for some GCHP files are appended to
#       the run directory path rather than the source code directory.
#       There may be path variables set to current directory that I have
#       not yet found but that are used in GCHP subdirectory Makefiles.
#   (2) This file only works (except for compiling) with recent GCHP_Dev
#       updates made by L. Lundgren to the GCHP/Makefile.
# 
# !REVISION HISTORY: 
#  Navigate to your unit tester directory and type 'gitk' at the prompt
#  to browse the revision history.
#EOP
#------------------------------------------------------------------------------
#BOC

# Unix shell (we'll assume Bash, which is on every Linux system)
SHELL        :=/bin/bash

###############################################################################
#####                                                                     #####
#####   CONFIGURABLE TOKENS: You can modify these for your environment.   #####
#####                                                                     #####
###############################################################################

# Source code location
ifndef GC_DIR
 CODEDIR_GC :=$(shell readlink -f ./CodeDir)
endif

# Output log file destination (default is run directory) 
ifndef LOG_DIR 
 LOG_DIR     :=.
endif

###############################################################################
#####                                                                     #####
#####  DEFAULT OPTIONS
#####                                                                     #####
###############################################################################

# GCHP code directory path
CODEDIR_GCHP     :=$(CODEDIR_GC)/GCHP

# Run directory path
RUN_DIR      :=$(shell pwd)

# Log files that will be written to the log directory
CLEAN_BUILD_LOG :="$(RUN_DIR)/compile_clean.log"
STD_BUILD_LOG   :="$(RUN_DIR)/compile_standard.log"
DEBUG_BUILD_LOG :="$(RUN_DIR)/compile_debug.log"
MAPL_LOG        :="$(RUN_DIR)/MAPL.log"
LAST_BUILD      :="$(RUN_DIR)/last_build_code_info.log"

# Executables
EXE          :=geos

# Code git information for GEOS-Chem repo
CODE_BRANCH_GC :=$(shell git -C $(CODEDIR_GC) rev-parse --abbrev-ref HEAD)
LAST_COMMIT_GC :=$(shell git -C $(CODEDIR_GC) log -n 1 --pretty=format:"%s") 
COMMIT_DATE_GC :=$(shell git -C $(CODEDIR_GC) log -n 1 --pretty=format:"%cd") 
COMMIT_USER_GC :=$(shell git -C $(CODEDIR_GC) log -n 1 --pretty=format:"%cn") 
COMMIT_HASH_GC :=$(shell git -C $(CODEDIR_GC) log -n 1 --pretty=format:"%h") 
CODE_STATUS_GC :=$(shell git -C $(CODEDIR_GC) status -s) 

# Code git information for GCHP repo
CODE_BRANCH_GCHP:=$(shell git -C $(CODEDIR_GCHP) rev-parse --abbrev-ref HEAD)
LAST_COMMIT_GCHP:=$(shell git -C $(CODEDIR_GCHP) log -n 1 --pretty=format:"%s")
COMMIT_DATE_GCHP:=$(shell git -C $(CODEDIR_GCHP) log -n 1 --pretty=format:"%cd")
COMMIT_USER_GCHP:=$(shell git -C $(CODEDIR_GCHP) log -n 1 --pretty=format:"%cn")
COMMIT_HASH_GCHP:=$(shell git -C $(CODEDIR_GCHP) log -n 1 --pretty=format:"%h") 
CODE_STATUS_GCHP:=$(shell git -C $(CODEDIR_GCHP) status -s) 

###############################################################################
#####                                                                     #####
#####                          MAKEFILE TARGETS                           #####
#####                                                                     #####
###############################################################################

# PHONY targets don't actually compile anything. They either are
# synonyms for other targets, they remove files, or they print output.
.PHONY: build_clean build_standard
.PHONY: run_6cpus   run_12cpus
.PHONY: fileclean   logclean   dataclean     allclean
.PHONY: execlean    gcclean    nuclearclean  superclean

#%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Build Only               %
#%%%%%%%%%%%%%%%%%%%%%%%%%%

build_clean:
	./build.sh compile_clean 2>&1 | tee $(CLEAN_BUILD_LOG)
	@$(MAKE) printbuildinfo > $(LAST_BUILD)

build_standard:
	./build.sh compile_standard 2>&1 | tee $(STD_BUILD_LOG)
	@$(MAKE) printbuildinfo > $(LAST_BUILD)

build_debug:
	./build.sh compile_debug 2>&1 | tee $(DEBUG_BUILD_LOG)
	@$(MAKE) printbuildinfo > $(LAST_BUILD)

#%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Run Only               %
#%%%%%%%%%%%%%%%%%%%%%%%%%%

run_6cpus:
	mpirun -n 6 ./$(EXE) 2>&1 | tee $(MAPL_LOG)

run_12cpus:
	mpirun -n 12 ./$(EXE) 2>&1 | tee $(MAPL_LOG)

#%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Remove Output Files    %
#%%%%%%%%%%%%%%%%%%%%%%%%%%

fileclean: dataclean logclean

dataclean: 
	rm -f $(RUN_DIR)/OutputDir/GCHP.center.*
	rm -f $(RUN_DIR)/OutputDir/GCHP.regrid.*
	rm -f trac_avg.*
	rm -f tracerinfo.dat
	rm -f diaginfo.dat
	rm -f cap_restart
	rm -f regrid.rcx
	rm -f center.rcx
	rm -f *~

logclean: 
	rm -f HEMCO.log
	rm -f PET00000.GEOSCHEMchem.log
	rm -f logfile.000000.out
	rm -f MAPL.log
	rm -f smv2.log
	rm -f slurm-*
	rm -f 1
	rm -f EGRESS 

execlean: 
	rm -f geos
	rm -f $(CLEAN_BUILD_LOG)
	rm -f $(STD_BUILD_LOG)
	rm -f $(DEBUG_BUILD_LOG)

#%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Clean Source Code      %
#   (BE CAREFUL!!!)       %
#%%%%%%%%%%%%%%%%%%%%%%%%%%

allclean:
	./build.sh clean_all

gcclean:
	./build.sh clean_gc

nuclearclean:
	./build.sh clean_nuclear

#%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Clean Everything       %
#   (BE CAREFUL!!!)       %
#%%%%%%%%%%%%%%%%%%%%%%%%%%

superclean:
	@$(MAKE) fileclean
	@$(MAKE) allclean

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Print information  (to be expanded)    %
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

printbuildinfo:
	@echo "LAST BUILD INFORMATION - GEOS-Chem:"
	@echo "   CODEDIR_GC        : $(CODEDIR_GC)"
	@echo "   CODE_BRANCH_GC    : $(CODE_BRANCH_GC)"
	@echo "   LAST_COMMIT_GC    : $(LAST_COMMIT_GC)"
	@echo "   COMMIT_DATE_GC    : $(COMMIT_DATE_GC)"
	@echo "   COMMIT_USER_GCHP  : $(COMMIT_USER_GC)"
	@echo "   COMMIT_HASH_GCHP  : $(COMMIT_HASH_GC)"
	@echo "   CODE_STATUS_GCHP  : $(CODE_STATUS_GC)"
	@echo "LAST BUILD INFORMATION - GCHP:"
	@echo "   CODEDIR_GCHP      : $(CODEDIR_GCHP)"
	@echo "   CODE_BRANCH_GCHP  : $(CODE_BRANCH_GCHP)"
	@echo "   LAST_COMMIT_GCHP  : $(LAST_COMMIT_GCHP)"
	@echo "   COMMIT_DATE_GCHP  : $(COMMIT_DATE_GCHP)"
	@echo "   COMMIT_USER_GCHP  : $(COMMIT_USER_GCHP)"
	@echo "   COMMIT_HASH_GCHP  : $(COMMIT_HASH_GCHP)"
	@echo "   CODE_STATUS_GCHP  : $(CODE_STATUS_GCHP)"


