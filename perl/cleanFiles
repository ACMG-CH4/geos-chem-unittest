#!/usr/bin/perl -w

#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: cleanFiles
#
# !DESCRIPTION: This Perl script removes all individual files from the
#  GEOS-Chem Unit Test log directory and job directory.
#\\
#\\
# !USES:
#
require 5.003;                 # Need this version of Perl or newer
use strict;                    # Force IMPLICIT NONE-style declarations
use UtUtils qw( &cleanDir
                &parse    );   # Get routines from the UtUtils module
#
# !PUBLIC MEMBER FUNCTIONS:
#
# &getDirs($)
# &cleanDir($)
# &main(@)         
#
# !CALLING SEQUENCE:
#  cleanFiles [ OPTIONS-FILENAME ]
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#  28 Aug 2013 - R. Yantosca - Now reference &cleanDir from UtUtils.pm
#EOP
#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !IROUTINE: getDefaults
#
# !DESCRIPTION: Reads the input file and returns the name of the directory 
#  where log files are stored.
#\\
#\\
# !INTERFACE:
#
sub getDirs($) {
#
# !INPUT PARAMETERS:
#
  my ( $fileName ) = @_;   # File with unit test input options
#
# !RETURN VALUE:
#
  my $jobDir       = "";    # Job script directory
  my $logDir       = "";    # Log file directory
  my $runDir       = "";    # Run directory
#
# !CALLING SEQUENCE:
#  &getDirs( $fileName );   # Saves values to global variables
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#  24 Mar 2014 - R. Yantosca - Now use $RUN_ROOT to get the root run dir
#  13 Mar 2015 - M. Sulprizio- Now get username for file paths
#EOP
#------------------------------------------------------------------------------
#BOC
#
# !LOCAL VARIABLES:
#
  my $user = "";
  my @txt  = ();

  # Read data from input file
  open( I, "<$fileName" ) or die "Cannot open $fileName!\n";
  chomp( @txt = <I> );
  close( I );

  # Get username
  $user= getpwuid($<);

  # Parse each line until we find the log directory
  for ( my $i = 0; $i < scalar( @txt ); $i++ ) {
    if ( $txt[$i] =~ "JOB_DIR"  ) { $jobDir = &parse( $txt[$i] ); }
    if ( $txt[$i] =~ "LOG_DIR"  ) { $logDir = &parse( $txt[$i] ); }
    if ( $txt[$i] =~ "RUN_ROOT" ) { $runDir = &parse( $txt[$i] ); }
  }

  # Replace directory tokens
  $jobDir =~ s/{USER}/$user/g;
  $logDir =~ s/{USER}/$user/g;
  $runDir =~ s/{USER}/$user/g;

  # Only get the root part of the run & log directories
#  $runDir =~ s/{RUNDIR}//g;
  $logDir =~ s/\/{VERSION}//g;

  # Return to main program
  return( $jobDir, $logDir, $runDir  );
}
#EOC
#------------------------------------------------------------------------------
#                  GEOS-Chem Global Chemical Transport Model                  !
#------------------------------------------------------------------------------
#BOP
#
# !IROUTINE: main
#
# !DESCRIPTION: Removes files from the GEOS-Chem Unit Test job script
#  directory and log file directory.
#\\
#\\
# !INTERFACE:
#
sub main() {
#
# !CALLING SEQUENCE:
#  cleanFiles [ OPTIONS-FILENAME ]
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#  03 Sep 2013 - R. Yantosca - Now do a "make fileclean" in the runs directory,
#                              which will remove files in run subdirectories
#  24 Mar 2014 - R. Yantosca - Add better test for directories
#  30 Jun 2014 - R. Yantosca - Now also call the extrafileclean target in the
#                              run directory makefiles.
#EOP
#------------------------------------------------------------------------------
#BOC
#
# !LOCAL VARIABLES:
#
  # Scalars
  my $cmd     = "";
  my $dir     = "";
  my $jobDir  = "";
  my $logDir  = "";
  my $optFile = "";
  my $runDir  = "";
  my $runRoot = "";
  my $result  = "";
  
  # Arrays
  my @dirs    = ();

  # If the user passes a filename from the command line, use it
  # Otherwise, default to "UnitTest.input"
  if ( scalar( @ARGV ) == 1 ) { $optFile = $ARGV[0];         }
  else                        { $optFile = "UnitTest.input"; }

  # Get the local directories
  ( $jobDir, $logDir, $runRoot ) = &getDirs( $optFile );

  # Remove job scripts
  &cleanDir( $jobDir );

  # Remove log files
  &cleanDir( $logDir );

  # Get all of the subdirectories of $runDir
  opendir( D, "$runRoot" ) or die "$runRoot is an invalid directory!\n";
  chomp( @dirs = readdir( D ) );
  closedir( D );

  # Loop over all contents in the root run directory ($RUN_ROOT)
  foreach $dir ( @dirs ) {

    # Construct full path name for subdirectory $dir
    $runDir = "$runRoot/$dir";

    # Make sure each directory is a directory and not a file
    if ( -d $runDir ) { 
      
      # Also Skip over . and ..
      if ( !( $dir =~ m/^\./ ) ) {

	# Skip over chem_inputs/
	if ( !( $dir =~ m/chem_inputs/ ) ) { 

	  # Remove files in each run directory ...
	  $cmd = "make -C $runDir fileclean";
	  chomp( $result = qx( $cmd ) );
  	  print "$result\n";

	  # ... and also remove input.geos, HEMCO_Config.rc
          # (we don't remove these in fileclean because that 
	  # would delete the files before they are ever used.)
	  $cmd = "make -C $runDir extrafileclean";
	  chomp( $result = qx( $cmd ) );
  	  print "$result\n";


        }
      }
    }
  }	

  # Return w/ status
  return( $? );
}
#EOC

#------------------------------------------------------------------------------

# Call main driver routine
main();

# Exit and pass status code to Unix shell
exit( $? );
