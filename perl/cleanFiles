#!/usr/bin/perl -w

#------------------------------------------------------------------------------
#          Harvard University Atmospheric Chemistry Modeling Group            !
#------------------------------------------------------------------------------
#BOP
#
# !MODULE: cleanFiles
#
# !DESCRIPTION: This Perl script removes all individual files from the
#  GEOS-Chem Unit Test log directory and job directory.
#\\
#\\
# !USES:
#
require 5.003;                 # Need this version of Perl or newer
use strict;                    # Force IMPLICIT NONE-style declarations
use UtUtils qw( &cleanDir
                &parse    );   # Get routines from the UtUtils module
#
# !PUBLIC MEMBER FUNCTIONS:
#
# &getDirs($)
# &cleanDir($)
# &main(@)         
#
# !CALLING SEQUENCE:
#  cleanFiles [ OPTIONS-FILENAME ]
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#  28 Aug 2013 - R. Yantosca - Now reference &cleanDir from UtUtils.pm
#EOP
#------------------------------------------------------------------------------
#          Harvard University Atmospheric Chemistry Modeling Group            !
#------------------------------------------------------------------------------
#BOP
#
# !IROUTINE: getDefaults
#
# !DESCRIPTION: Reads the input file and returns the name of the directory 
#  where log files are stored.
#\\
#\\
# !INTERFACE:
#
sub getDirs($) {
#
# !INPUT PARAMETERS:
#
  my ( $fileName ) = @_;   # File with unit test input options
#
# !RETURN VALUE:
#
  my $jobDir       = "";    # Job script directory
  my $logDir       = "";    # Log file directory
  my $runDir       = "";    # Run directory
#
# !CALLING SEQUENCE:
#  &getDirs( $fileName );   # Saves values to global variables
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#EOP
#------------------------------------------------------------------------------
#BOC
#
# !LOCAL VARIABLES:
#
  my @txt = ();

  # Read data from input file
  open( I, "<$fileName" ) or die "Cannot open $fileName!\n";
  chomp( @txt = <I> );
  close( I );

  # Parse each line until we find the log directory
  for ( my $i = 0; $i < scalar( @txt ); $i++ ) {
    if ( $txt[$i] =~ "JOB_DIR" ) { $jobDir = &parse( $txt[$i] ); }
    if ( $txt[$i] =~ "LOG_DIR" ) { $logDir = &parse( $txt[$i] ); }
    if ( $txt[$i] =~ "RUN_DIR" ) { $runDir = &parse( $txt[$i] ); }
  }

  # Only get the root part of the run & log directories
  $runDir =~ s/{RUNDIR}//g;
  $logDir =~ s/\/{VERSION}//g;

  # Return to main program
  return( $jobDir, $logDir, $runDir  );
}
#EOC
#------------------------------------------------------------------------------
#          Harvard University Atmospheric Chemistry Modeling Group            !
#------------------------------------------------------------------------------
#BOP
#
# !IROUTINE: main
#
# !DESCRIPTION: Removes files from the GEOS-Chem Unit Test job script
#  directory and log file directory.
#\\
#\\
# !INTERFACE:
#
sub main() {
#
# !CALLING SEQUENCE:
#  cleanFiles [ OPTIONS-FILENAME ]
#
# !REVISION HISTORY:
#  26 Aug 2013 - R. Yantosca - Initial version
#  03 Sep 2013 - R. Yantosca - Now do a "make fileclean" in the runs directory,
#                              which will remove files in run subdirectories
#EOP
#------------------------------------------------------------------------------
#BOC
#
# !LOCAL VARIABLES:
#
  # Scalars
  my $cmd     = "";
  my $dir     = "";
  my $jobDir  = "";
  my $logDir  = "";
  my $optFile = "";
  my $runDir  = "";
  my $result  = "";
  
  # Arrays
  my @dirs    = ();

  # If the user passes a filename from the command line, use it
  # Otherwise, default to "UnitTest.input"
  if ( scalar( @ARGV ) == 1 ) { $optFile = $ARGV[0];         }
  else                        { $optFile = "UnitTest.input"; }

  # Get the log file directory
  ( $jobDir, $logDir, $runDir ) = &getDirs( $optFile );

  # Remove job scripts
  &cleanDir( $jobDir );

  # Remove log files
  &cleanDir( $logDir );

  # Get all of the subdirectories of $runDir
  opendir( D, "$runDir" ) or die "$runDir is an invalid directory!\n";
  chomp( @dirs = readdir( D ) );
  closedir( D );

  # Execute "make fileclean" in each run directory
  foreach $dir ( @dirs ) {
    if ( !( $dir =~ m/^\./ ) ) {
      if ( !( $dir =~ m/chem_inputs/ ) ) { 
	$cmd = "make -C $runDir/$dir fileclean";
	chomp( $result = qx( $cmd ) );
	print "$result\n";
      }
    }
  }	

  # Return w/ status
  return( $? );
}
#EOC

#------------------------------------------------------------------------------

# Call main driver routine
main();

# Exit and pass status code to Unix shell
exit( $? );
